<!DOCTYPE html>
<html lang="ru" data-theme="dark" data-lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LiveSky</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root {
      color-scheme: dark;
    }
    :root[data-theme="light"] {
      color-scheme: light;
    }
    body {
      font-family: "Inter", "Manrope", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), transparent 55%),
                  radial-gradient(circle at 20% 20%, rgba(192, 132, 252, 0.2), transparent 45%),
                  linear-gradient(180deg, #020617, #0f172a 55%, #0b1120);
      min-height: 100vh;
      transition: background 0.6s ease, color 0.4s ease;
      color: #f8fafc;
    }
    body[data-time="night"] {
      background: radial-gradient(circle at top, rgba(30, 41, 59, 0.5), transparent 55%),
                  linear-gradient(180deg, #020617, #0f172a 85%, #0b1120);
    }
    body[data-time="morning"] {
      background: radial-gradient(circle at top, rgba(251, 191, 36, 0.4), transparent 55%),
                  linear-gradient(180deg, #f59e0b, #ef4444 55%, #f97316);
    }
    body[data-time="day"] {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.4), transparent 55%),
                  linear-gradient(180deg, #0ea5e9, #3b82f6 55%, #6366f1);
    }
    body[data-time="evening"] {
      background: radial-gradient(circle at top, rgba(192, 132, 252, 0.4), transparent 55%),
                  linear-gradient(180deg, #8b5cf6, #a855f7 55%, #c084fc);
    }
    body.light-mode {
      background: radial-gradient(circle at top, rgba(14, 165, 233, 0.6), transparent 50%),
                  radial-gradient(circle at 80% 0%, rgba(249, 168, 212, 0.6), transparent 45%),
                  radial-gradient(circle at bottom, rgba(255, 255, 255, 0.9), transparent 60%),
                  linear-gradient(180deg, #f8fafc, #dbeafe, #bfdbfe);
      color: #0f172a;
    }
    body.light-mode[data-time="night"] {
      background: radial-gradient(circle at top, rgba(30, 41, 59, 0.6), transparent 55%),
                  linear-gradient(180deg, #f8fafc, #e2e8f0, #cbd5e1);
    }
    body.light-mode[data-time="morning"] {
      background: radial-gradient(circle at top, rgba(251, 191, 36, 0.6), transparent 55%),
                  linear-gradient(180deg, #fef3c7, #fde68a, #fbbf24);
    }
    body.light-mode[data-time="day"] {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.6), transparent 55%),
                  linear-gradient(180deg, #e0f2fe, #bae6fd, #7dd3fc);
    }
    body.light-mode[data-time="evening"] {
      background: radial-gradient(circle at top, rgba(192, 132, 252, 0.6), transparent 55%),
                  linear-gradient(180deg, #f3e8ff, #e9d5ff, #d8b4fe);
    }
    body[data-weather="cloudy"] {
      background: linear-gradient(180deg, #6b7280, #4b5563 55%, #374151);
    }
    body[data-weather="cloudy"][data-time="night"] {
      background: linear-gradient(180deg, #111827, #1f2937 55%, #374151);
    }
    body.light-mode[data-weather="cloudy"] {
      background: linear-gradient(180deg, #e5e7eb, #d1d5db 55%, #9ca3af);
    }
    .glass {
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(18px);
      background: rgba(15, 23, 42, 0.55);
      transition: all 0.3s ease;
    }
    body.light-mode .glass {
      border-color: rgba(15, 23, 42, 0.18);
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.98), rgba(235, 241, 250, 0.98), rgba(219, 234, 254, 0.95));
      box-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    }
    .gradient-border {
      position: relative;
      border-radius: 32px;
      overflow: hidden;
      isolation: isolate;
    }
    .gradient-border::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 2px;
      background: linear-gradient(120deg, #38bdf8, #c084fc, #fb7185);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
      opacity: 0.8;
    }
    .aura {
      position: absolute;
      inset: 0;
      opacity: 0.55;
      pointer-events: none;
    }
    .theme-toggle, .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.85rem;
      border-radius: 999px;
      padding: 0.45rem 1rem 0.45rem 0.45rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(15, 23, 42, 0.65);
      box-shadow: 0 18px 36px rgba(2, 6, 23, 0.35);
      transition: border 0.3s ease, background 0.3s ease, transform 0.2s ease;
    }
    body.light-mode .theme-toggle, body.light-mode .lang-toggle {
      border-color: rgba(15, 23, 42, 0.18);
      background: rgba(248, 250, 252, 0.95);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
    }
    .theme-toggle:hover, .lang-toggle:hover {
      transform: translateY(-2px);
    }
    .theme-toggle .toggle-icon, .lang-toggle .toggle-icon {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      color: #f8fafc;
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.35), rgba(14, 165, 233, 0.5));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2), 0 12px 18px rgba(14, 165, 233, 0.15);
    }
    body.light-mode .theme-toggle .toggle-icon, body.light-mode .lang-toggle .toggle-icon {
      color: #0f172a;
      background: linear-gradient(145deg, rgba(251, 191, 36, 0.45), rgba(248, 113, 113, 0.45));
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3), 0 12px 18px rgba(248, 113, 113, 0.2);
    }
    .toggle-label__hint {
      letter-spacing: 0.35em;
      font-size: 0.55rem;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }
    body.light-mode .toggle-label__hint {
      color: rgba(71, 85, 105, 0.9);
    }
    .toggle-label__value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #f8fafc;
    }
    body.light-mode .toggle-label__value {
      color: #0f172a;
    }
    .hour-strip {
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.6) transparent;
      scroll-snap-type: x mandatory;
      scroll-padding: 1rem;
      mask-image: linear-gradient(90deg, transparent, #000 5%, #000 95%, transparent);
      transition: all 0.3s ease;
    }
    .hour-strip::-webkit-scrollbar {
      height: 6px;
    }
    .hour-strip::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }
    .hour-card {
      position: relative;
      transition: transform 0.25s ease, background 0.25s ease, border-color 0.25s ease;
      scroll-snap-align: start;
      border-radius: 24px;
      border: 2px solid rgba(255, 255, 255, 0.12);
      background: inherit;
      overflow: hidden;
      cursor: pointer;
      will-change: transform;
    }
    body.light-mode .hour-card {
      border-color: rgba(15, 23, 42, 0.15);
      background: inherit;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }
    .hour-card#current-hour {
      border-color: rgba(56, 189, 248, 0.8);
    }
    body.light-mode .hour-card#current-hour {
      border-color: rgba(14, 165, 233, 0.8);
    }
    .hour-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.25), transparent 55%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .hour-card:hover {
      transform: translateY(-6px);
    }
    .hour-card:hover::after {
      opacity: 1;
    }
    .pulse-ring {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pulse-ring::after {
      content: "";
      position: absolute;
      width: 120%;
      height: 120%;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.5);
      animation: pulse 2.6s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(0.6); opacity: 0.7; }
      70% { transform: scale(1.3); opacity: 0; }
      100% { opacity: 0; }
    }
    /* Weather Effects */
    #weather-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      pointer-events: none;
      z-index: -1;
      opacity: 0;
      transition: opacity 1.5s ease;
    }
    body.light-mode #weather-effects {
      opacity: 0.7;
    }
    #weather-effects.effects-on {
      opacity: 1;
    }
    /* Sun */
    .weather-sun::before {
      content: '';
      position: absolute;
      top: -20vh;
      right: -20vh;
      width: 60vh;
      height: 60vh;
      background: radial-gradient(circle, rgba(253, 224, 71, 0.2) 0%, rgba(253, 224, 71, 0) 60%);
      animation: pulse-sun 8s infinite ease-in-out;
    }
    @keyframes pulse-sun {
      0% { transform: scale(0.9); opacity: 0.15; }
      50% { transform: scale(1.05); opacity: 0.25; }
      100% { transform: scale(0.9); opacity: 0.15; }
    }
    body.light-mode .weather-sun::before {
      background: radial-gradient(circle, rgba(251, 191, 36, 0.4) 0%, rgba(251, 191, 36, 0) 60%);
      opacity: 0.8;
    }
    /* Clouds */
    .weather-clouds .cloud {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      width: 200px;
      height: 60px;
      filter: blur(10px);
      animation: move-cloud 60s linear infinite;
    }
    .weather-clouds .cloud::before, .weather-clouds .cloud::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }
    .weather-clouds .cloud::before { width: 100px; height: 100px; top: -50px; left: 40px; }
    .weather-clouds .cloud::after { width: 140px; height: 140px; top: -70px; right: 20px; }
    .weather-clouds .cloud:nth-child(1) { top: 10%; left: -250px; transform: scale(0.8); animation-duration: 65s; }
    .weather-clouds .cloud:nth-child(2) { top: 30%; left: -300px; transform: scale(1.2); animation-duration: 50s; animation-delay: -10s; }
    .weather-clouds .cloud:nth-child(3) { top: 60%; left: -200px; transform: scale(1); animation-duration: 45s; animation-delay: -25s; }
    body.light-mode .weather-clouds .cloud,
    body.light-mode .weather-clouds .cloud::before,
    body.light-mode .weather-clouds .cloud::after {
      background: rgba(15, 23, 42, 0.1);
      filter: blur(12px);
    }
    @keyframes move-cloud {
      from { transform: translateX(0); }
      to { transform: translateX(calc(100vw + 300px)); }
    }
    /* Rain / Snow */
    .weather-rain .drop, .weather-snow .drop {
      position: absolute;
      bottom: 100%;
      width: 2px;
      height: 80px;
      background: linear-gradient(to top, rgba(56, 189, 248, 0), rgba(56, 189, 248, 0.5));
      animation: fall 1s linear infinite;
    }
    .weather-snow .drop {
      background: linear-gradient(to top, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.8));
      width: 3px;
      height: 10px;
    }
    @keyframes fall {
      from { transform: translateY(0vh); }
      to { transform: translateY(110vh); }
    }
    /* Storm */
    .weather-storm::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.3);
      animation: flash 4s linear infinite;
    }
    body.light-mode .weather-storm::before {
      background: rgba(255, 255, 255, 0.3);
    }
    @keyframes flash {
      0%, 100% { opacity: 0; }
      2%, 6% { opacity: 1; }
      4%, 8% { opacity: 0; }
      5% { opacity: 1; }
    }

    /* Autocomplete Suggestions */
    .suggestion-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .suggestion-item:hover {
      background: rgba(56, 189, 248, 0.2);
    }
    body.light-mode .suggestion-item:hover {
      background: rgba(14, 165, 233, 0.1);
    }
    
    /* View Transitions API Animation */
    ::view-transition-old(root),
    ::view-transition-new(root) {
      animation: none;
      mix-blend-mode: normal;
    }
    ::view-transition-old(root) { z-index: 100; }
    ::view-transition-new(root) { z-index: 200; }
    [data-theme="dark"]::view-transition-new(root) {
      animation: reveal-dark 0.8s ease-out;
    }
    [data-theme="light"]::view-transition-new(root) {
      animation: reveal-light 0.8s ease-out;
    }
    @keyframes reveal-dark {
      from { clip-path: circle(0% at 50% 50%); }
      to { clip-path: circle(150% at 50% 50%); }
    }
    @keyframes reveal-light {
      from { clip-path: circle(0% at 50% 50%); }
      to { clip-path: circle(150% at 50% 50%); }
    }
    
    /* Map */
    #map {
      height: 200px;
      border-radius: 24px;
      margin-top: 1rem;
      transition: height 0.3s ease;
      z-index: 1;
    }
    
    /* Daily Card */
    .daily-card {
      position: relative;
      transition: transform 0.25s ease, background 0.25s ease, border-color 0.25s ease;
      border-radius: 24px;
      border: 2px solid rgba(255, 255, 255, 0.12);
      background: inherit;
      overflow: hidden;
      cursor: pointer;
      min-width: 130px;
    }
    body.light-mode .daily-card {
      border-color: rgba(15, 23, 42, 0.15);
      background: inherit;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }
    
    /* Monthly Modal */
    #monthly-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 50;
      transition: opacity 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }
    
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .hero-grid {
        grid-template-columns: 1fr;
      }
      .theme-toggle, .lang-toggle {
        width: 100%;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      .hour-strip, .daily-strip {
        scroll-snap-type: x proximity;
      }
      .hour-card, .daily-card {
        min-width: 100px;
      }
      #map {
        height: 150px;
      }
    }
    @media (max-width: 640px) {
      .hero-grid {
        grid-template-columns: 1fr;
      }
      .hour-card, .daily-card {
        min-width: 90px;
      }
    }

    /* Loader Animation */
    #loader {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #loader.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .spinner {
      border: 8px solid rgba(255, 255, 255, 0.3);
      border-top: 8px solid #ffffff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Theme Selector Modal */
    #theme-selector {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #theme-selector.active {
      opacity: 1;
      pointer-events: auto;
    }
    #theme-selector .glass {
      padding: 2rem;
      text-align: center;
    }
    #theme-selector button {
      display: block;
      margin: 1rem auto;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: #38bdf8;
      color: white;
      cursor: pointer;
    }

    /* Autocomplete z-index */
    #autocomplete-list {
      z-index: 30;
    }
  </style>
</head>
<body class="text-white light:text-slate-950 selection:bg-cyan-300/40">
  <div id="weather-effects"></div>
  <div id="loader" class="hidden">
    <div class="spinner"></div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-10 space-y-10">
    <header class="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
      <div class="space-y-3">
        <p class="tracking-[0.3em] text-xs uppercase text-slate-300 light:text-slate-900" data-text="realtime_weather">Realtime Weather</p>
      </div>
      <div class="flex gap-4">
        <button id="themeToggle" class="theme-toggle">
          <span id="themeIcon" class="toggle-icon">üåô</span>
          <span class="flex flex-col text-left">
            <span class="toggle-label__hint" data-text="mode">—Ä–µ–∂–∏–º</span>
            <span class="toggle-label__value" data-text="change_theme">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</span>
          </span>
        </button>
        <button id="langToggle" class="lang-toggle">
          <span class="toggle-icon">üá∑üá∫</span>
          <span class="flex flex-col text-left">
            <span class="toggle-label__hint" data-text="language">—è–∑—ã–∫</span>
            <span class="toggle-label__value" data-text="change_lang">–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫</span>
          </span>
        </button>
      </div>
    </header>

    <section class="gradient-border">
      <div class="glass rounded-[30px] p-6 sm:p-10 relative overflow-hidden">
        <div class="aura">
          <div class="absolute -top-12 right-0 w-60 h-60 bg-cyan-500/20 blur-3xl"></div>
          <div class="absolute -bottom-16 left-0 w-72 h-72 bg-indigo-500/25 blur-3xl"></div>
        </div>
        <div class="relative grid hero-grid grid-cols-1 md:grid-cols-[1.5fr_1fr] gap-8">
          <div class="space-y-8">
            <div>
              <p class="text-xs uppercase tracking-[0.4em] text-slate-300 light:text-slate-900" data-text="now_in">–°–µ–π—á–∞—Å –≤</p>
              <h2 id="location" class="text-3xl sm:text-4xl font-semibold">‚Äî</h2>
              <p id="updated" class="text-slate-300 light:text-slate-900">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div class="flex flex-wrap gap-6 items-end">
              <div>
                <p class="text-slate-300 light:text-slate-900 text-sm" data-text="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</p>
                <p id="temperature" class="text-6xl font-bold leading-none">‚Äî¬∞C</p>
              </div>
              <div class="space-y-2 text-sm text-slate-200 light:text-slate-950">
                <p><span class="text-slate-400 light:text-slate-900" data-text="feels_like">–ü–æ –æ—â—É—â–µ–Ω–∏—è–º:</span> <span id="feels">‚Äî¬∞C</span></p>
                <p><span class="text-slate-400 light:text-slate-900" data-text="wind">–í–µ—Ç–µ—Ä:</span> <span id="wind">‚Äî –º/—Å</span></p>
                <p><span class="text-slate-400 light:text-slate-900" data-text="precip">–û—Å–∞–¥–∫–∏:</span> <span id="rainInfo">‚Äî</span></p>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="flex-1 relative">
                <form id="cityForm" class="flex gap-2">
                  <input id="cityInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö–∞–∑–∞–Ω—å)" class="flex-1 rounded-2xl px-4 py-3 bg-white/10 border border-white/20 light:border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-400 text-white light:text-slate-950 placeholder:text-slate-300 light:placeholder:text-slate-700" autocomplete="off" />
                  <button class="px-5 py-3 rounded-2xl bg-gradient-to-r from-cyan-400 to-sky-500 text-slate-900 font-semibold shadow-lg shadow-cyan-500/40" data-text="find">–ù–∞–π—Ç–∏</button>
                </form>
                <div id="autocomplete-list" class="absolute top-full left-0 right-0 mt-2 z-10 glass rounded-2xl overflow-hidden max-h-60 overflow-y-auto hidden">
                  <!-- Autocomplete suggestions -->
                </div>
              </div>
              <button id="useLocation" class="px-5 py-3 rounded-2xl border border-white/20 light:border-slate-600 light:bg-white/10 text-sm uppercase tracking-[0.2em] font-semibold text-white/80 light:text-slate-950 hover:text-white light:hover:text-slate-950 transition" data-text="my_location">–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è</button>
            </div>
            <div id="map"></div>
          </div>
          <div class="space-y-4">
            <div class="glass rounded-3xl p-5 space-y-3">
              <p class="text-sm text-slate-300 light:text-slate-900" data-text="will_rain">–ë—É–¥–µ—Ç –ª–∏ –¥–æ–∂–¥—å?</p>
              <p id="rainVerdict" class="text-lg font-semibold">–ñ–¥—ë–º –ø—Ä–æ–≥–Ω–æ–∑‚Ä¶</p>
              <div class="flex gap-4">
                <div class="flex-1 bg-cyan-500/15 rounded-2xl p-4">
                  <p class="text-xs uppercase tracking-[0.3em] text-cyan-200 light:text-cyan-950" data-text="chance">–®–∞–Ω—Å</p>
                  <p id="precipChance" class="text-3xl font-semibold">‚Äî%</p>
                </div>
                <div class="flex-1 bg-indigo-500/15 rounded-2xl p-4">
                  <p class="text-xs uppercase tracking-[0.3em] text-indigo-200 light:text-indigo-950" data-text="amount">–û–±—ä—ë–º</p>
                  <p id="precipAmount" class="text-3xl font-semibold">‚Äî –º–º</p>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="glass rounded-2xl p-4">
                <p class="text-slate-400 light:text-slate-900" data-text="feels_like">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫</p>
                <p id="detailFeels" class="text-2xl font-semibold">‚Äî¬∞C</p>
              </div>
              <div class="glass rounded-2xl p-4">
                <p class="text-slate-400 light:text-slate-900" data-text="wind_gusts">–ü–æ—Ä—ã–≤—ã –≤–µ—Ç—Ä–∞</p>
                <p id="detailWindGusts" class="text-2xl font-semibold">‚Äî –º/—Å</p>
              </div>
              <div class="glass rounded-2xl p-4">
                <p class="text-slate-400 light:text-slate-900" data-text="wind_speed">–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞</p>
                <p id="detailWind" class="text-2xl font-semibold">‚Äî –º/—Å</p>
              </div>
              <div class="glass rounded-2xl p-4">
                <p class="text-slate-400 light:text-slate-900" data-text="atmosphere">–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞</p>
                <p id="detailWeather" class="text-2xl font-semibold">‚Äî</p>
              </div>
              <div class="glass rounded-2xl p-4 col-span-2">
                <p class="text-slate-400 light:text-slate-900" data-text="sunrise_sunset">–í–æ—Å—Ö–æ–¥/–ó–∞–∫–∞—Ç</p>
                <p id="sunTimes" class="text-2xl font-semibold">‚Äî / ‚Äî</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="glass rounded-3xl p-6 border border-white/10">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold" data-text="next_hours">–ë–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã</h3>
          <p id="hourlyRange" class="text-sm text-slate-400 light:text-slate-900">‚Äî</p>
        </div>
        <div class="flex items-center gap-2 text-sm text-slate-400 light:text-slate-900">
          <span class="w-2 h-2 rounded-full bg-cyan-400"></span>
          <span data-text="precip_prob">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤</span>
        </div>
      </div>
      <div id="hourlyStrip" class="hour-strip flex gap-4 overflow-x-auto pb-2"></div>
    </section>

    <section class="glass rounded-3xl p-6 border border-white/10">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold" data-text="next_days">–ë–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏</h3>
          <p id="dailyRange" class="text-sm text-slate-400 light:text-slate-900">‚Äî</p>
        </div>
        <button id="monthlyForecast" class="px-5 py-3 rounded-2xl bg-gradient-to-r from-cyan-400 to-sky-500 text-slate-900 font-semibold shadow-lg shadow-cyan-500/40" data-text="monthly_forecast">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü</button>
      </div>
      <div id="dailyStrip" class="hour-strip flex gap-4 overflow-x-auto pb-2"></div>
    </section>
  </div>

  <footer class="text-center text-xs text-slate-500 py-6">
    –î–∞–Ω–Ω—ã–µ Open-Meteo ¬∑ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ –≤–∞—à–µ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É
  </footer>

  <!-- Hourly Modal -->
  <div id="hourly-modal" class="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div id="modal-content" class="glass rounded-3xl p-6 sm:p-8 max-w-sm w-full relative transition-all duration-300 scale-95 opacity-0">
      <button id="modal-close" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 light:bg-black/10 text-white light:text-slate-950 flex items-center justify-center text-2xl leading-none pb-1">&times;</button>
      <div class="space-y-4">
        <p class="text-lg font-semibold text-slate-300 light:text-slate-900" data-text="weather_at">–ü–æ–≥–æ–¥–∞ –≤ <span id="modal-time">--:--</span></p>
        <div class="flex items-end gap-4">
          <p id="modal-temp" class="text-6xl font-bold">--¬∞</p>
          <p class="text-slate-400 light:text-slate-900" data-text="feels_like">–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ <span id="modal-feel" class="font-semibold text-white light:text-slate-950">--¬∞</span></p>
        </div>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="glass rounded-2xl p-4">
            <p class="text-slate-400 light:text-slate-900" data-text="description">–û–ø–∏—Å–∞–Ω–∏–µ</p>
            <p id="modal-weather" class="text-lg font-semibold">‚Äî</p>
          </div>
          <div class="glass rounded-2xl p-4">
            <p class="text-slate-400 light:text-slate-900" data-text="wind_ms">–í–µ—Ç–µ—Ä (–º/—Å)</p>
            <p id="modal-wind" class="text-lg font-semibold">‚Äî</p>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 space-y-2">
          <p class="text-slate-400 light:text-slate-900" data-text="precip_prob">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤</p>
          <p id="modal-prob" class="text-3xl font-semibold">‚Äî%</p>
          <div class="h-2 rounded-full bg-white/10 light:bg-slate-300/50">
            <div id="modal-prob-bar" class="h-full rounded-full bg-cyan-400" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Modal -->
  <div id="daily-modal" class="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div id="daily-modal-content" class="glass rounded-3xl p-6 sm:p-8 max-w-sm w-full relative transition-all duration-300 scale-95 opacity-0">
      <button id="daily-modal-close" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 light:bg-black/10 text-white light:text-slate-950 flex items-center justify-center text-2xl leading-none pb-1">&times;</button>
      <div class="space-y-4">
        <p class="text-lg font-semibold text-slate-300 light:text-slate-900" data-text="weather_at">–ü–æ–≥–æ–¥–∞ –Ω–∞ <span id="daily-modal-date">--</span></p>
        <div class="flex items-end gap-4">
          <p id="daily-modal-temp" class="text-6xl font-bold">--¬∞ / --¬∞</p>
        </div>
        <div class="grid grid-cols-1 gap-3 text-sm">
          <div class="glass rounded-2xl p-4">
            <p class="text-slate-400 light:text-slate-900" data-text="description">–û–ø–∏—Å–∞–Ω–∏–µ</p>
            <p id="daily-modal-weather" class="text-lg font-semibold">‚Äî</p>
          </div>
          <div class="glass rounded-2xl p-4 space-y-2">
            <p class="text-slate-400 light:text-slate-900" data-text="precip_prob">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤</p>
            <p id="daily-modal-prob" class="text-3xl font-semibold">‚Äî%</p>
            <div class="h-2 rounded-full bg-white/10 light:bg-slate-300/50">
              <div id="daily-modal-prob-bar" class="h-full rounded-full bg-cyan-400" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Monthly Modal -->
  <div id="monthly-modal" class="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="glass rounded-3xl p-6 sm:p-8 max-w-4xl w-full relative transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-80vh">
      <button id="monthly-close" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 light:bg-black/10 text-white light:text-slate-950 flex items-center justify-center text-2xl leading-none pb-1">&times;</button>
      <h3 class="text-xl font-semibold mb-4" data-text="monthly_forecast">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü</h3>
      <div id="monthly-content" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <!-- Theme Selector Modal -->
  <div id="theme-selector" class="fixed inset-0 bg-black/50 backdrop-blur-md flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="glass rounded-3xl p-6 sm:p-8 max-w-sm w-full relative transition-all duration-300 scale-95 opacity-0">
      <button id="theme-selector-close" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/10 light:bg-black/10 text-white light:text-slate-950 flex items-center justify-center text-2xl leading-none pb-1">&times;</button>
      <h3 class="text-xl font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h3>
      <button onclick="selectTheme('dynamic')">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</button>
      <button onclick="selectTheme('dark')">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
      <button onclick="selectTheme('light')">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</button>
    </div>
  </div>

  <script>
    const state = {
      coords: null,
      placeName: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
      theme: 'dynamic',
      lang: 'ru',
      themeMode: 'dynamic' // dynamic, dark, light
    };

    const texts = {
      ru: {
        realtime_weather: 'Realtime Weather',
        mode: '—Ä–µ–∂–∏–º',
        change_theme: '–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É',
        language: '—è–∑—ã–∫',
        change_lang: '–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫',
        now_in: '–°–µ–π—á–∞—Å –≤',
        temperature: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
        feels_like: '–ü–æ –æ—â—É—â–µ–Ω–∏—è–º',
        wind: '–í–µ—Ç–µ—Ä',
        precip: '–û—Å–∞–¥–∫–∏',
        find: '–ù–∞–π—Ç–∏',
        my_location: '–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è',
        will_rain: '–ë—É–¥–µ—Ç –ª–∏ –¥–æ–∂–¥—å?',
        chance: '–®–∞–Ω—Å',
        amount: '–û–±—ä—ë–º',
        wind_gusts: '–ü–æ—Ä—ã–≤—ã –≤–µ—Ç—Ä–∞',
        wind_speed: '–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞',
        atmosphere: '–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞',
        sunrise_sunset: '–í–æ—Å—Ö–æ–¥/–ó–∞–∫–∞—Ç',
        next_hours: '–ë–ª–∏–∂–∞–π—à–∏–µ —á–∞—Å—ã',
        precip_prob: '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Å–∞–¥–∫–æ–≤',
        next_days: '–ë–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏',
        monthly_forecast: '–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü',
        weather_at: '–ü–æ–≥–æ–¥–∞ –≤',
        description: '–û–ø–∏—Å–∞–Ω–∏–µ',
        wind_ms: '–í–µ—Ç–µ—Ä (–º/—Å)',
      },
      en: {
        realtime_weather: 'Realtime Weather',
        mode: 'mode',
        change_theme: 'Change theme',
        language: 'language',
        change_lang: 'Change language',
        now_in: 'Now in',
        temperature: 'Temperature',
        feels_like: 'Feels like',
        wind: 'Wind',
        precip: 'Precipitation',
        find: 'Find',
        my_location: 'My location',
        will_rain: 'Will it rain?',
        chance: 'Chance',
        amount: 'Amount',
        wind_gusts: 'Wind gusts',
        wind_speed: 'Wind speed',
        atmosphere: 'Atmosphere',
        sunrise_sunset: 'Sunrise/Sunset',
        next_hours: 'Next hours',
        precip_prob: 'Precipitation probability',
        next_days: 'Next days',
        monthly_forecast: 'Monthly forecast',
        weather_at: 'Weather at',
        description: 'Description',
        wind_ms: 'Wind (m/s)',
      }
    };

    const el = {
      location: document.getElementById('location'),
      updated: document.getElementById('updated'),
      temperature: document.getElementById('temperature'),
      feels: document.getElementById('feels'),
      wind: document.getElementById('wind'),
      rainInfo: document.getElementById('rainInfo'),
      rainVerdict: document.getElementById('rainVerdict'),
      precipChance: document.getElementById('precipChance'),
      precipAmount: document.getElementById('precipAmount'),
      detailFeels: document.getElementById('detailFeels'),
      detailWind: document.getElementById('detailWind'),
      detailWindGusts: document.getElementById('detailWindGusts'),
      detailWeather: document.getElementById('detailWeather'),
      sunTimes: document.getElementById('sunTimes'),
      hourlyStrip: document.getElementById('hourlyStrip'),
      hourlyRange: document.getElementById('hourlyRange'),
      dailyStrip: document.getElementById('dailyStrip'),
      dailyRange: document.getElementById('dailyRange'),
      themeToggle: document.getElementById('themeToggle'),
      themeIcon: document.getElementById('themeIcon'),
      langToggle: document.getElementById('langToggle'),
      weatherEffects: document.getElementById('weather-effects'),
      hourlyModal: document.getElementById('hourly-modal'),
      modalContent: document.getElementById('modal-content'),
      modalClose: document.getElementById('modal-close'),
      dailyModal: document.getElementById('daily-modal'),
      dailyModalContent: document.getElementById('daily-modal-content'),
      dailyModalClose: document.getElementById('daily-modal-close'),
      monthlyModal: document.getElementById('monthly-modal'),
      monthlyClose: document.getElementById('monthly-close'),
      monthlyContent: document.getElementById('monthly-content'),
      monthlyForecast: document.getElementById('monthlyForecast'),
      cityInput: document.getElementById('cityInput'),
      autocompleteList: document.getElementById('autocomplete-list'),
      map: document.getElementById('map'),
      loader: document.getElementById('loader'),
      themeSelector: document.getElementById('theme-selector'),
      themeSelectorClose: document.getElementById('theme-selector-close')
    };

    let debounceTimer;
    let mapInstance;

    const weatherCodeMap = {
      ru: {
        0: '–Ø—Å–Ω–æ',
        1: '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ',
        2: '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å',
        3: '–ü–∞—Å–º—É—Ä–Ω–æ',
        45: '–¢—É–º–∞–Ω',
        48: '–¢—É–º–∞–Ω —Å –∏–∑–º–æ—Ä–æ–∑—å—é',
        51: '–õ—ë–≥–∫–∞—è –º–æ—Ä–æ—Å—å',
        53: '–£–º–µ—Ä–µ–Ω–Ω–∞—è –º–æ—Ä–æ—Å—å',
        55: '–°–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å',
        56: '–õ—ë–≥–∫–∞—è –ª–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å',
        57: '–°–∏–ª—å–Ω–∞—è –ª–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å',
        61: '–ù–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å',
        63: '–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å',
        65: '–õ–∏–≤–µ–Ω—å',
        66: '–õ—ë–≥–∫–∏–π –ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å',
        67: '–°–∏–ª—å–Ω—ã–π –ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å',
        71: '–ù–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥',
        73: '–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–Ω–µ–≥',
        75: '–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥',
        77: '–°–Ω–µ–∂–Ω—ã–µ –∫—Ä—É–ø–∏–Ω–∫–∏',
        80: '–ù–µ–±–æ–ª—å—à–∏–µ –ª–∏–≤–Ω–∏',
        81: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –ª–∏–≤–Ω–∏',
        82: '–°–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏',
        85: '–°–Ω–µ–≥–æ–ø–∞–¥',
        86: '–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥',
        95: '–ì—Ä–æ–∑–∞',
        96: '–ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º',
        99: '–°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º'
      },
      en: {
        0: 'Clear',
        1: 'Mainly clear',
        2: 'Partly cloudy',
        3: 'Overcast',
        45: 'Fog',
        48: 'Depositing rime fog',
        51: 'Light drizzle',
        53: 'Moderate drizzle',
        55: 'Dense drizzle',
        56: 'Light freezing drizzle',
        57: 'Dense freezing drizzle',
        61: 'Slight rain',
        63: 'Moderate rain',
        65: 'Heavy rain',
        66: 'Light freezing rain',
        67: 'Heavy freezing rain',
        71: 'Slight snow fall',
        73: 'Moderate snow fall',
        75: 'Heavy snow fall',
        77: 'Snow grains',
        80: 'Slight rain showers',
        81: 'Moderate rain showers',
        82: 'Violent rain showers',
        85: 'Slight snow showers',
        86: 'Heavy snow showers',
        95: 'Thunderstorm',
        96: 'Thunderstorm with slight hail',
        99: 'Thunderstorm with heavy hail'
      }
    };

    function updateTexts() {
      document.querySelectorAll('[data-text]').forEach(elem => {
        const key = elem.dataset.text;
        elem.textContent = texts[state.lang][key] || elem.textContent;
      });
      document.documentElement.lang = state.lang;
      el.langToggle.querySelector('.toggle-icon').textContent = state.lang === 'ru' ? 'üá∑üá∫' : 'üá∫üá∏';
      el.cityInput.placeholder = state.lang === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö–∞–∑–∞–Ω—å)' : 'Enter city (e.g., Kazan)';
    }

    function clearSuggestions() {
      el.autocompleteList.innerHTML = '';
      el.autocompleteList.classList.add('hidden');
    }

    function renderSuggestions(results) {
      clearSuggestions();
      if (!results || results.length === 0) return;

      results.forEach(city => {
        const item = document.createElement('div');
        item.className = 'suggestion-item text-sm light:text-slate-800';
        
        let label = city.name;
        if (city.admin1) label += `, ${city.admin1}`;
        if (city.country) label += `, ${city.country}`;
        item.textContent = label;
        
        item.addEventListener('click', () => {
          el.cityInput.value = city.name;
          clearSuggestions();
          state.coords = { latitude: city.latitude, longitude: city.longitude };
          state.placeName = label;
          fetchWeather(city.latitude, city.longitude, label);
        });
        el.autocompleteList.appendChild(item);
      });
      
      el.autocompleteList.classList.remove('hidden');
    }

    async function fetchCitySuggestions(query) {
      if (query.length < 3) {
        clearSuggestions();
        return;
      }
      const lang = state.lang;
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=${lang}&format=json`;
      try {
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        renderSuggestions(data.results);
      } catch (error) {
        console.error('Error fetching suggestions:', error);
        clearSuggestions();
      }
    }

    function applyTheme(theme) {
      state.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      document.body.classList.toggle('light-mode', theme === 'light');
      el.themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      localStorage.setItem('livesky-theme', theme);
    }

    function initTheme() {
      const saved = localStorage.getItem('livesky-theme');
      if (saved) {
        applyTheme(saved);
      } else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }
    }

    function applyLanguage(lang) {
      state.lang = lang;
      localStorage.setItem('livesky-lang', lang);
      updateTexts();
    }

    function initLanguage() {
      const saved = localStorage.getItem('livesky-lang');
      applyLanguage(saved || 'ru');
    }

    async function fetchWeather(lat, lon, label) {
      showLoader();
      try {
        const params = new URLSearchParams({
          latitude: lat,
          longitude: lon,
          current_weather: 'true',
          hourly: 'temperature_2m,apparent_temperature,precipitation_probability,precipitation,weathercode,windspeed_10m,windgusts_10m',
          daily: 'temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max,weathercode',
          windspeed_unit: 'ms',
          timezone: 'auto',
          forecast_days: 7
        });
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`);
        if (!res.ok) throw new Error('Failed to fetch forecast');
        const data = await res.json();
        updateUI(data, label);
        updateMap(lat, lon);
      } catch (error) {
        el.updated.textContent = error.message;
      } finally {
        hideLoader();
      }
    }

    async function fetchMonthlyWeather(lat, lon) {
      const params = new URLSearchParams({
        latitude: lat,
        longitude: lon,
        daily: 'temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode',
        timezone: 'auto',
        forecast_days: 16
      });
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`);
      if (!res.ok) return [];
      const data = await res.json();
      return data.daily;
    }

    function setTimeOfDay(sunrise, sunset, currentTime, weathercode) {
      const sr = new Date(sunrise);
      const ss = new Date(sunset);
      const now = new Date(currentTime);
      let timeOfDay = 'day';
      if (now < sr) timeOfDay = 'night';
      else if (now < new Date(sr.getTime() + 2 * 60 * 60 * 1000)) timeOfDay = 'morning';
      else if (now > ss) timeOfDay = 'night';
      else if (now > new Date(ss.getTime() - 2 * 60 * 60 * 1000)) timeOfDay = 'evening';
      document.body.dataset.time = timeOfDay;

      // Cloudy weather
      const cloudyCodes = [2, 3, 45, 48];
      if (cloudyCodes.includes(weathercode)) {
        document.body.dataset.weather = 'cloudy';
      } else {
        document.body.removeAttribute('data-weather');
      }
    }

    function setWeatherEffects(code) {
      const effectsContainer = el.weatherEffects;
      effectsContainer.innerHTML = '';
      effectsContainer.className = 'effects-on';

      if ([0, 1].includes(code)) {
        effectsContainer.classList.add('weather-sun');
      } else if ([2, 3, 45, 48].includes(code)) {
        effectsContainer.classList.add('weather-clouds');
        effectsContainer.innerHTML = '<div class="cloud"></div><div class="cloud"></div><div class="cloud"></div>';
      } else if ([51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82].includes(code)) {
        effectsContainer.classList.add('weather-rain');
        let drops = '';
        for (let i = 0; i < 50; i++) {
          drops += `<div class="drop" style="left: ${Math.random() * 100}%; animation-delay: ${Math.random() * 2}s; height: ${Math.random() * 80 + 40}px;"></div>`;
        }
        effectsContainer.innerHTML = drops;
      } else if ([95, 96, 99].includes(code)) {
        effectsContainer.classList.add('weather-storm');
      } else if ([71, 73, 75, 77, 85, 86].includes(code)) {
        effectsContainer.classList.add('weather-snow');
        let flakes = '';
        for (let i = 0; i < 50; i++) {
          flakes += `<div class="drop" style="left: ${Math.random() * 100}%; animation-delay: ${Math.random() * 5}s; animation-duration: ${Math.random() * 3 + 4}s;"></div>`;
        }
        effectsContainer.innerHTML = flakes;
      } else {
        effectsContainer.className = '';
      }
    }

    function updateUI(data, label) {
      const { current_weather, hourly, daily } = data;
      let nowIndex = hourly.time.findIndex(t => t === current_weather.time);
      if (nowIndex === -1) {
        nowIndex = 0;
      }
      const feelsLike = hourly.apparent_temperature[nowIndex];
      const precipNow = hourly.precipitation[nowIndex];
      const precipProb = hourly.precipitation_probability[nowIndex];

      el.location.textContent = label;

      const updateTime = new Date(current_weather.time);
      if (!isNaN(updateTime)) {
        el.updated.textContent = state.lang === 'ru' ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤ ${updateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}` : `Updated at ${updateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        el.updated.textContent = state.lang === 'ru' ? '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è' : 'Failed to get time';
      }
        
      el.temperature.textContent = `${Math.round(current_weather.temperature)}¬∞C`;
      el.feels.textContent = `${Math.round(feelsLike)}¬∞C`;
      el.wind.textContent = `${current_weather.windspeed.toFixed(1)} m/s`;
      el.rainInfo.textContent = precipNow > 0 ? (state.lang === 'ru' ? '–î–∞, –∏–¥—É—Ç –æ—Å–∞–¥–∫–∏' : 'Yes, precipitating') : (state.lang === 'ru' ? '–û—Å–∞–¥–∫–æ–≤ –Ω–µ—Ç' : 'No precipitation');

      el.detailFeels.textContent = `${Math.round(feelsLike)}¬∞C`;
      el.detailWind.textContent = `${current_weather.windspeed.toFixed(1)} m/s`;
      const gust = hourly.windgusts_10m?.[nowIndex] ?? current_weather.windspeed;
      el.detailWindGusts.textContent = `${Number(gust).toFixed(1)} m/s`;
      el.detailWeather.textContent = weatherCodeMap[state.lang][current_weather.weathercode] || '‚Äî';

      const upcomingProb = hourly.precipitation_probability.slice(nowIndex, nowIndex + 24);
      const upcomingAmounts = hourly.precipitation.slice(nowIndex, nowIndex + 24);
      const willRain = upcomingProb.some(p => p >= 50);
      el.rainVerdict.textContent = willRain ? (state.lang === 'ru' ? '–°–µ–≥–æ–¥–Ω—è –≤–æ–∑–º–æ–∂–µ–Ω –¥–æ–∂–¥—å ‚Äî –∑–∞—Ö–≤–∞—Ç–∏—Ç–µ –∑–æ–Ω—Ç!' : 'Rain possible today - take an umbrella!') : (state.lang === 'ru' ? '–î–æ–∂–¥—è –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è, –º–æ–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—É–ª–∫–∏.' : 'No rain expected, plan outings.');
      el.precipChance.textContent = `${Math.max(...upcomingProb)}%`;
      const totalPrecip = upcomingAmounts.reduce((sum, v) => sum + v, 0);
      el.precipAmount.textContent = `${totalPrecip.toFixed(1)} mm`;

      const todaySunrise = daily.sunrise[0];
      const todaySunset = daily.sunset[0];
      el.sunTimes.textContent = `${new Date(todaySunrise).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })} / ${new Date(todaySunset).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}`;

      setTimeOfDay(todaySunrise, todaySunset, current_weather.time, current_weather.weathercode);
      setWeatherEffects(current_weather.weathercode);
      renderHourly(hourly, nowIndex);
      renderDaily(daily);
    }

    function updateMap(lat, lon) {
      if (!mapInstance) {
        mapInstance = L.map('map').setView([lat, lon], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapInstance);
      } else {
        mapInstance.setView([lat, lon], 10);
      }
      mapInstance.eachLayer(layer => { if (layer instanceof L.Marker) mapInstance.removeLayer(layer); });
      L.circleMarker([lat, lon], {
        radius: 8,
        fillColor: "#ff7800",
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(mapInstance);
    }

    function renderHourly(hourly, startIndex) {
      const hoursBefore = 4;
      const hoursAfter = 8;
      const sliceStart = Math.max(0, startIndex - hoursBefore);
      const sliceEnd = Math.min(hourly.time.length, startIndex + hoursAfter);
      
      const sliceTimes = hourly.time.slice(sliceStart, sliceEnd);
      const temps = hourly.temperature_2m.slice(sliceStart, sliceEnd);
      const feels = hourly.apparent_temperature.slice(sliceStart, sliceEnd);
      const precipProb = hourly.precipitation_probability.slice(sliceStart, sliceEnd);
      const weathercodes = hourly.weathercode.slice(sliceStart, sliceEnd);
      const windspeeds = hourly.windspeed_10m.slice(sliceStart, sliceEnd);

      el.hourlyStrip.innerHTML = '';
      const formatter = new Intl.DateTimeFormat(state.lang === 'ru' ? 'ru-RU' : 'en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
      let currentHourCard = null;

      sliceTimes.forEach((timeStr, idx) => {
        const actualIndex = sliceStart + idx;
        const date = new Date(timeStr);
        const hourData = {
          time: formatter.format(date),
          temp: Math.round(temps[idx]),
          feel: Math.round(feels[idx]),
          prob: precipProb[idx],
          code: weathercodes[idx],
          wind: windspeeds[idx].toFixed(1),
          weather: weatherCodeMap[state.lang][weathercodes[idx]] || 'No data'
        };

        const card = document.createElement('div');
        card.className = 'hour-card min-w-[130px] rounded-2xl p-4 flex flex-col gap-2 text-sm';
        card.innerHTML = `
          <p class="text-slate-300 light:text-slate-900 text-xs">${hourData.time}</p>
          <p class="text-3xl font-semibold">${hourData.temp}¬∞</p>
          <p class="text-slate-400 light:text-slate-900 text-xs">${texts[state.lang].feels_like} ${hourData.feel}¬∞</p>
          <div class="h-1.5 rounded-full bg-white/10 light:bg-slate-300/50">
            <div class="h-full rounded-full bg-cyan-400" style="width:${hourData.prob}%"></div>
          </div>
          <p class="text-slate-400 light:text-slate-900 text-xs">${texts[state.lang].precip_prob} ${hourData.prob}%</p>
        `;
        
        if (actualIndex === startIndex) {
          card.id = 'current-hour';
          currentHourCard = card;
        }

        card.addEventListener('click', () => showHourlyModal(hourData));
        el.hourlyStrip.appendChild(card);
      });

      if (currentHourCard) {
        setTimeout(() => {
          currentHourCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }, 100);
      }

      if (sliceTimes.length) {
        const rangeStart = new Date(sliceTimes[0]);
        const rangeEnd = new Date(sliceTimes[sliceTimes.length - 1]);
        el.hourlyRange.textContent = `${rangeStart.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })} ‚Äî ${rangeEnd.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}`;
      } else {
        el.hourlyRange.textContent = '‚Äî';
      }
    }

    function renderDaily(daily) {
      el.dailyStrip.innerHTML = '';
      const formatter = new Intl.DateTimeFormat(state.lang === 'ru' ? 'ru-RU' : 'en-US', { weekday: 'short', month: 'short', day: 'numeric' });

      daily.time.forEach((timeStr, idx) => {
        const date = new Date(timeStr);
        const dayData = {
          date: formatter.format(date),
          maxTemp: Math.round(daily.temperature_2m_max[idx]),
          minTemp: Math.round(daily.temperature_2m_min[idx]),
          prob: daily.precipitation_probability_max[idx],
          code: daily.weathercode[idx],
          weather: weatherCodeMap[state.lang][daily.weathercode[idx]] || 'No data'
        };

        const card = document.createElement('div');
        card.className = 'daily-card min-w-[130px] rounded-2xl p-4 flex flex-col gap-2 text-sm';
        card.innerHTML = `
          <p class="text-slate-300 light:text-slate-900 text-xs">${dayData.date}</p>
          <p class="text-3xl font-semibold">${dayData.maxTemp}¬∞ / ${dayData.minTemp}¬∞</p>
          <p class="text-slate-400 light:text-slate-900 text-xs">${dayData.weather}</p>
          <div class="h-1.5 rounded-full bg-white/10 light:bg-slate-300/50">
            <div class="h-full rounded-full bg-cyan-400" style="width:${dayData.prob}%"></div>
          </div>
          <p class="text-slate-400 light:text-slate-900 text-xs">${texts[state.lang].precip_prob} ${dayData.prob}%</p>
        `;

        card.addEventListener('click', () => showDailyModal(dayData));
        el.dailyStrip.appendChild(card);
      });

      if (daily.time.length) {
        const rangeStart = new Date(daily.time[0]);
        const rangeEnd = new Date(daily.time[daily.time.length - 1]);
        el.dailyRange.textContent = `${formatter.format(rangeStart)} ‚Äî ${formatter.format(rangeEnd)}`;
      } else {
        el.dailyRange.textContent = '‚Äî';
      }
    }

    async function showMonthlyModal() {
      el.monthlyContent.innerHTML = '<p>Loading...</p>';
      el.monthlyModal.classList.remove('opacity-0', 'pointer-events-none');
      el.monthlyModal.querySelector('.glass').classList.remove('scale-95', 'opacity-0');

      const { latitude, longitude } = state.coords;
      const monthly = await fetchMonthlyWeather(latitude, longitude);
      if (!monthly.time) return;

      el.monthlyContent.innerHTML = '';
      const formatter = new Intl.DateTimeFormat(state.lang === 'ru' ? 'ru-RU' : 'en-US', { weekday: 'long', month: 'long', day: 'numeric' });

      monthly.time.forEach((timeStr, idx) => {
        const date = new Date(timeStr);
        const dayData = {
          date: formatter.format(date),
          maxTemp: Math.round(monthly.temperature_2m_max[idx]),
          minTemp: Math.round(monthly.temperature_2m_min[idx]),
          prob: monthly.precipitation_probability_max[idx],
          code: monthly.weathercode[idx],
          weather: weatherCodeMap[state.lang][monthly.weathercode[idx]] || 'No data'
        };

        const card = document.createElement('div');
        card.className = 'daily-card rounded-2xl p-4 flex flex-col gap-2 text-sm';
        card.innerHTML = `
          <p class="text-slate-300 light:text-slate-900 text-xs">${dayData.date}</p>
          <p class="text-3xl font-semibold">${dayData.maxTemp}¬∞ / ${dayData.minTemp}¬∞</p>
          <p class="text-slate-400 light:text-slate-900 text-xs">${dayData.weather}</p>
          <div class="h-1.5 rounded-full bg-white/10 light:bg-slate-300/50">
            <div class="h-full rounded-full bg-cyan-400" style="width:${dayData.prob}%"></div>
          </div>
          <p class="text-slate-400 light:text-slate-900 text-xs">${texts[state.lang].precip_prob} ${dayData.prob}%</p>
        `;
        el.monthlyContent.appendChild(card);
      });
    }

    function closeMonthlyModal() {
      el.monthlyModal.querySelector('.glass').classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        el.monthlyModal.classList.add('opacity-0', 'pointer-events-none');
      }, 300);
    }

    function showHourlyModal(data) {
      document.getElementById('modal-time').textContent = data.time;
      document.getElementById('modal-temp').textContent = `${data.temp}¬∞`;
      document.getElementById('modal-feel').textContent = `${data.feel}¬∞`;
      document.getElementById('modal-weather').textContent = data.weather;
      document.getElementById('modal-wind').textContent = data.wind;
      document.getElementById('modal-prob').textContent = `${data.prob}%`;
      document.getElementById('modal-prob-bar').style.width = `${data.prob}%`;
      
      el.hourlyModal.classList.remove('opacity-0', 'pointer-events-none');
      el.modalContent.classList.remove('scale-95', 'opacity-0');
    }

    function closeModal() {
      el.modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        el.hourlyModal.classList.add('opacity-0', 'pointer-events-none');
      }, 300);
    }

    function showDailyModal(data) {
      document.getElementById('daily-modal-date').textContent = data.date;
      document.getElementById('daily-modal-temp').textContent = `${data.maxTemp}¬∞ / ${data.minTemp}¬∞`;
      document.getElementById('daily-modal-weather').textContent = data.weather;
      document.getElementById('daily-modal-prob').textContent = `${data.prob}%`;
      document.getElementById('daily-modal-prob-bar').style.width = `${data.prob}%`;
      
      el.dailyModal.classList.remove('opacity-0', 'pointer-events-none');
      el.dailyModalContent.classList.remove('scale-95', 'opacity-0');
    }

    function closeDailyModal() {
      el.dailyModalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        el.dailyModal.classList.add('opacity-0', 'pointer-events-none');
      }, 300);
    }

    async function geocodeCity(city) {
      const lang = state.lang;
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=${lang}&format=json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(state.lang === 'ru' ? '–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω' : 'City not found');
      const data = await res.json();
      if (!data.results?.length) throw new Error(state.lang === 'ru' ? '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π' : 'No matches found');
      const { latitude, longitude, name, country } = data.results[0];
      return { lat: latitude, lon: longitude, label: `${name}, ${country}` };
    }

    function requestUserLocation() {
      if (!navigator.geolocation) {
        el.updated.textContent = state.lang === 'ru' ? '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º' : 'Geolocation not supported by browser';
        return;
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        el.updated.textContent = state.lang === 'ru' ? '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS –∏–ª–∏ localhost. –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.' : 'Geolocation requires HTTPS or localhost. Enter city manually.';
        // Fallback to default city (e.g., Moscow)
        geocodeCity(state.lang === 'ru' ? '–ú–æ—Å–∫–≤–∞' : 'Moscow').then(({ lat, lon, label }) => {
          state.coords = { latitude: lat, longitude: lon };
          fetchWeather(lat, lon, label);
        }).catch(() => {
          el.updated.textContent = state.lang === 'ru' ? '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' : 'Default load error';
        });
        return;
      }
      el.updated.textContent = state.lang === 'ru' ? '–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...' : 'Requesting geolocation...';
      showLoader();
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          state.coords = { latitude, longitude };
          fetchWeather(latitude, longitude, state.lang === 'ru' ? '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ' : 'Your location');
        },
        (err) => {
          console.error(err);
          hideLoader();
          el.updated.textContent = state.lang === 'ru' ? '–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.' : 'Geolocation error. Enter city manually.';
          // Fallback to default city
          geocodeCity(state.lang === 'ru' ? '–ú–æ—Å–∫–≤–∞' : 'Moscow').then(({ lat, lon, label }) => {
            state.coords = { latitude: lat, longitude: lon };
            fetchWeather(lat, lon, label);
          }).catch(() => {
            el.updated.textContent = state.lang === 'ru' ? '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' : 'Default load error';
          });
        },
        { timeout: 10000 }
      );
    }

    function showLoader() {
      el.loader.classList.remove('hidden');
    }

    function hideLoader() {
      el.loader.classList.add('hidden');
    }

    function showThemeSelector() {
      el.themeSelector.classList.add('active');
      el.themeSelector.querySelector('.glass').classList.remove('scale-95', 'opacity-0');
    }

    function closeThemeSelector() {
      el.themeSelector.querySelector('.glass').classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        el.themeSelector.classList.remove('active');
      }, 300);
    }

    function selectTheme(mode) {
      state.themeMode = mode;
      localStorage.setItem('livesky-theme-mode', mode);
      if (mode === 'dynamic') {
        // Use time-based
        document.body.setAttribute('data-theme', state.theme); // restore last
      } else {
        applyTheme(mode);
        document.body.removeAttribute('data-time');
      }
      closeThemeSelector();
    }

    // Init theme mode
    const savedMode = localStorage.getItem('livesky-theme-mode') || 'dynamic';
    state.themeMode = savedMode;
    if (savedMode !== 'dynamic') {
      applyTheme(savedMode);
      document.body.removeAttribute('data-time');
    }

    document.getElementById('cityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearSuggestions();
      const value = el.cityInput.value.trim();
      if (!value) return;
      el.updated.textContent = state.lang === 'ru' ? '–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞‚Ä¶' : 'Searching city...';
      showLoader();
      try {
        const { lat, lon, label } = await geocodeCity(value);
        state.coords = { latitude: lat, longitude: lon };
        state.placeName = label;
        fetchWeather(lat, lon, label);
      } catch (error) {
        hideLoader();
        el.updated.textContent = error.message;
      }
    });

    el.cityInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      const query = e.target.value;
      debounceTimer = setTimeout(() => {
        fetchCitySuggestions(query);
      }, 300);
    });

    document.addEventListener('click', (e) => {
      if (!el.cityInput.contains(e.target) && !el.autocompleteList.contains(e.target)) {
        clearSuggestions();
      }
    });

    el.useLocation.addEventListener('click', requestUserLocation);

    el.themeToggle.addEventListener('click', showThemeSelector);

    el.themeSelectorClose.addEventListener('click', closeThemeSelector);
    el.themeSelector.addEventListener('click', (e) => {
      if (e.target === el.themeSelector) closeThemeSelector();
    });

    el.langToggle.addEventListener('click', () => {
      const nextLang = state.lang === 'ru' ? 'en' : 'ru';
      applyLanguage(nextLang);
      if (state.coords) {
        fetchWeather(state.coords.latitude, state.coords.longitude, el.location.textContent);
      }
    });

    el.modalClose.addEventListener('click', closeModal);
    el.hourlyModal.addEventListener('click', (e) => {
      if (e.target === el.hourlyModal) closeModal();
    });

    el.dailyModalClose.addEventListener('click', closeDailyModal);
    el.dailyModal.addEventListener('click', (e) => {
      if (e.target === el.dailyModal) closeDailyModal();
    });

    el.monthlyForecast.addEventListener('click', showMonthlyModal);
    el.monthlyClose.addEventListener('click', closeMonthlyModal);
    el.monthlyModal.addEventListener('click', (e) => {
      if (e.target === el.monthlyModal) closeMonthlyModal();
    });

    initTheme();
    initLanguage();
    requestUserLocation();
  </script>
</body>
</html>